# Donchian Breakout Strategy Explained

This document provides a detailed explanation of the Donchian Breakout Strategy as implemented in this trading project.

## 1. What are Donchian Channels?

Donchian Channels are a technical indicator developed by Richard Donchian. They are formed by taking the highest high and the lowest low of an asset over a predefined period (e.g., 20 days). The channels consist of three lines:

*   **Upper Channel**: The highest price reached by the asset over the specified look-back period (`length`).
*   **Lower Channel**: The lowest price reached by the asset over the specified look-back period (`length`).
*   **Middle Channel (optional but used in this strategy)**: The average of the Upper and Lower Channels. ((Upper Channel + Lower Channel) / 2).

Donchian Channels are primarily used to identify trends, breakouts, and potential reversal points. A breakout above the upper channel might suggest the start of a new uptrend, while a break below the lower channel might indicate the start of a new downtrend.

## 2. Donchian Breakout Strategy Implementation (`trading_strategies.py`)

The `DonchianBreakoutStrategy` class in `trading_strategies.py` implements a trading strategy based on these channels.

### 2.1. Initialization and Parameters

The strategy is initialized with two key parameters, typically loaded from the `trading_config.ini` file (e.g., from a section like `[STRATEGY_CONFIG_DonchianStandard]`):

*   **`length` (integer)**: This is the look-back period used to calculate the Donchian Channels. For example, a `length` of 20 means the channels will be based on the highest high and lowest low of the last 20 price bars (candles).
*   **`exit_option` (integer)**: This parameter defines the condition under which an open BUY position (initiated by a breakout above the upper channel) will be exited based on Donchian Channel crossovers.
    *   **`exit_option = 1`**: The strategy will generate an EXIT signal (-1) if the closing price crosses *below the Lower Donchian Channel*. This is a more traditional Donchian exit.
    *   **`exit_option = 2`**: The strategy will generate an EXIT signal (-1) if the closing price crosses *below the Middle Donchian Channel*. This provides a potentially earlier exit signal compared to option 1.

### 2.2. Calculation of Donchian Channels

The Donchian Channels themselves are calculated within the `DataPrep` class, specifically in the `_add_donchian_channels` method (called by `calculate_statistics`). It computes:
*   `Donchian_Upper`: Rolling `length`-period maximum of the 'high' prices.
*   `Donchian_Lower`: Rolling `length`-period minimum of the 'low' prices.
*   `Donchian_Mid`: (`Donchian_Upper` + `Donchian_Lower`) / 2.

These calculated channels are then added as columns to the NIFTY index DataFrame.

### 2.3. Signal Generation (`generate_signals` method)

The `generate_signals` method of the `DonchianBreakoutStrategy` class takes the NIFTY index DataFrame (which now includes the Donchian Channel columns) and generates trading signals:

*   **BUY Signal (1)**:
    *   A BUY signal is generated if the `close` price of the current candle crosses *above* the `Donchian_Upper` channel from the *previous* candle.
    *   Specifically, `df['close'] > df['Donchian_Upper'].shift(1)`.
    *   This indicates a bullish breakout.

*   **SELL/EXIT Signal (-1)** (for an existing BUY position):
    *   The generation of an EXIT signal depends on the `exit_option` parameter:
        *   If `exit_option == 1`: An EXIT signal is generated if the `close` price of the current candle crosses *below* the `Donchian_Lower` channel from the *previous* candle.
            *   Specifically, `df['close'] < df['Donchian_Lower'].shift(1)`.
        *   If `exit_option == 2`: An EXIT signal is generated if the `close` price of the current candle crosses *below* the `Donchian_Mid` channel from the *previous* candle.
            *   Specifically, `df['close'] < df['Donchian_Mid'].shift(1)`.

*   **HOLD Signal (0)**:
    *   If neither a BUY nor a SELL/EXIT condition is met, a HOLD signal is generated.

The method returns the DataFrame with an added 'signal' column containing these 1, -1, or 0 values.

## 3. Simulation of the Donchian Breakout Strategy (`trading_simulator.py`)

The `TradingSimulator` class uses the signals generated by the `DonchianBreakoutStrategy` on the NIFTY 50 index to simulate trades on NIFTY options.

### 3.1. Setup from Configuration

When `trading_simulator.py` is run, it reads `trading_config.ini`. If a Donchian strategy (e.g., `STRATEGY_CONFIG_DonchianStandard`) is selected:
*   The `DonchianBreakoutStrategy` class is instantiated with `length` and `exit_option` from the config.
*   The `TradingSimulator` is instantiated with:
    *   The NIFTY index token (`index_token`).
    *   The instantiated `DonchianBreakoutStrategy` object.
    *   Trade start and end dates.
    *   `option_type` (e.g., 'CE' for Call Options, indicating a focus on uptrend reversals/breakouts).
    *   `trade_interval` (e.g., 'minute', '5minute').
    *   `trade_params` dictionary containing:
        *   `units`: Number of option lots to trade.
        *   `profit_target_pct`: Percentage profit target for an option trade.
        *   `stop_loss_pct`: Percentage stop loss for an option trade.
        *   `max_holding_period_minutes`: Maximum duration to hold an option trade.

### 3.2. Simulation Flow for a NIFTY BUY Signal

1.  **NIFTY Signal Processing**: The simulator first runs the `DonchianBreakoutStrategy` on the NIFTY index data for the specified `trade_interval` to get BUY, SELL/EXIT, and HOLD signals for the NIFTY index itself.

2.  **Option Selection**: When the strategy generates a BUY signal (1) on the NIFTY index at a specific time (`nifty_signal_time`) and NIFTY price (`nifty_price_at_signal`):
    *   If `option_type` is 'CE', the simulator calls `_find_closest_CE_option`. This method queries the database to find the NIFTY Call Option token whose strike price is closest to (and typically just above or at) the `nifty_price_at_signal`, for options expiring in the current month.
    *   (A similar process for 'PE' options would occur if configured, using `_find_closest_PE_option`).

3.  **Option Data Fetching**: Once a suitable option token is identified:
    *   The simulator fetches historical OHLCV data for this specific option token for the period from `nifty_signal_time.date()` to the overall `trade_end_date` of the simulation, at the specified `trade_interval`. This is done via `DataPrep.fetch_and_prepare_data`.

4.  **Simulating the Option Trade (`_simulate_single_trade_on_option`)**:
    *   **Entry**: The option trade is entered at the `open` price of the first available option candle at or immediately after `nifty_signal_time`.
    *   **Exit Condition Monitoring**: The simulator then monitors the option's price action minute by minute (or based on the `trade_interval` of the option data) for the following exit conditions, checked in this order of priority:
        1.  **NIFTY Strategy Exit Signal**:
            *   The simulator checks if the underlying `DonchianBreakoutStrategy` (running on NIFTY index data) generates an EXIT signal (-1) at any point during the option's holding period.
            *   If so, the option position is closed at the `close` price of the current option candle. This ensures the option trade respects the primary strategy's exit logic on the index.
        2.  **Profit Target Hit**:
            *   If the `high` price of the current option candle reaches or exceeds `option_entry_price * (1 + profit_target_pct)`.
            *   The trade is exited at the `profit_target_price`.
        3.  **Stop Loss Hit**:
            *   If the `low` price of the current option candle reaches or falls below `option_entry_price * (1 - stop_loss_pct)`.
            *   The trade is exited at the `stop_loss_price`.
        4.  **Maximum Holding Period Reached**:
            *   If the trade has been open for `max_holding_period_minutes`.
            *   The trade is exited at the `close` price of the current option candle.
        5.  **End of Option Data**: If the available OHLCV data for the option token runs out before any other exit condition is met. The trade is exited at the `close` of the last available candle.

5.  **Logging**: Each simulated option trade (entry time/price, exit time/price, PNL, exit reason) is logged.

### 3.3. Outcome

This process allows the system to:
*   Use the Donchian Breakout strategy to identify potential breakout (BUY) signals on the NIFTY 50 index.
*   Translate these index signals into simulated trades on corresponding NIFTY Call Options.
*   Manage these option trades based on a combination of the primary NIFTY strategy's exit signals, predefined profit/loss targets, and a maximum holding time.

The effectiveness of this strategy configuration can then be evaluated using the performance metrics generated by the simulator. 